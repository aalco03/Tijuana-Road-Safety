{% extends 'base.html' %}

{% block title %}Report a Pothole{% endblock %}

{% block content %}
<div class="container" style="margin-top: 20px;">
    <h1>Report a Pothole</h1>
</div>

    <form method="post" enctype="multipart/form-data" class="form-container">
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="error">{{ form.non_field_errors }}</div>
            {% endif %}

            <div class="form-group">
                {{ form.phone_number.label_tag }} {{ form.phone_number }}
                {% if form.phone_number.errors %}
                    <div class="error">{{ form.phone_number.errors }}</div>
                {% endif %}
                <span class="info-icon">
                    &#9432;
                    <span class="tooltip">Note: If you wish to audit your own report, or update it in the future without needing further review, then please include your phone number.</span>
                </span>
            </div>

            <div class="form-group">
                {{ form.severity.label_tag }} {{ form.severity }}
                {% if form.severity.errors %}
                    <div class="error">{{ form.severity.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.image.label_tag }} {{ form.image }}
                {% if form.image.errors %}
                    <div class="error">{{ form.image.errors }}</div>
                {% endif %}
            </div>

            <input type="hidden" id="id_latitude" name="latitude" value="">
            <input type="hidden" id="id_longitude" name="longitude" value="">

            <div class="map-container">
                <p style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">Click on the map to place the pothole location:</p>
                <div id="map"></div>
            </div>

            <button type="submit" class="submit-btn" id="submit-btn">Submit</button>
        </form>

    <!-- Nearby Potholes Modal -->
    <div id="nearby-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; max-height: 80%; overflow-y: auto;">
            <h2 style="font-family: 'Shrikhand', serif; color: #2c3e50; margin-bottom: 20px;">Nearby Potholes Found!</h2>
            <p style="margin-bottom: 20px; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">We found existing pothole reports near your location. Is your pothole one of these?</p>
            
            <div id="nearby-potholes-list"></div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button type="button" id="submit-new-pothole" class="submit-btn" style="margin-right: 10px;">No, Submit New Report</button>
                <button type="button" id="cancel-submission" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>

    <script>
        var map;
        var marker;

        var tijuanaBounds = {
            north: 32.566,
            south: 32.441,
            west: -117.122,
            east: -116.905
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                minZoom: 10,
                center: {lat: 32.5149, lng: -117.0382},
                restriction: {
                    latLngBounds: tijuanaBounds,
                    strictBounds: true
                },
                scrollwheel: true,
                draggable: true
            });

            map.addListener('click', function(event) {
                if (isWithinBounds(event.latLng)) {
                    placeMarker(event.latLng);
                } else {
                    alert("Please click within the Tijuana city bounds.");
                }
            });
        }

        function placeMarker(location) {
            if (marker) {
                marker.setPosition(location);
            } else {
                marker = new google.maps.Marker({
                    position: location,
                    map: map
                });
            }

            document.getElementById('id_latitude').value = location.lat();
            document.getElementById('id_longitude').value = location.lng();
        }

        function isWithinBounds(latLng) {
            return latLng.lat() >= tijuanaBounds.south &&
                   latLng.lat() <= tijuanaBounds.north &&
                   latLng.lng() >= tijuanaBounds.west &&
                   latLng.lng() <= tijuanaBounds.east;
        }

        // Proximity detection and modal functionality
        let nearbyPotholes = [];
        let formSubmissionPending = false;

        function checkNearbyPotholes(latitude, longitude) {
            const formData = new FormData();
            formData.append('latitude', latitude);
            formData.append('longitude', longitude);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch('/api/check-nearby-potholes/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.nearby_potholes && data.nearby_potholes.length > 0) {
                    nearbyPotholes = data.nearby_potholes;
                    showNearbyPotholesModal(data.nearby_potholes);
                } else {
                    // No nearby potholes, proceed with normal submission
                    document.querySelector('form').submit();
                }
            })
            .catch(error => {
                console.error('Error checking nearby potholes:', error);
                // On error, proceed with normal submission
                document.querySelector('form').submit();
            });
        }

        function showNearbyPotholesModal(potholes) {
            const modal = document.getElementById('nearby-modal');
            const potholesList = document.getElementById('nearby-potholes-list');
            
            potholesList.innerHTML = '';
            
            potholes.forEach((pothole, index) => {
                const potholeDiv = document.createElement('div');
                potholeDiv.style.cssText = 'border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; background: #f9f9f9;';
                
                potholeDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        ${pothole.image_url ? 
                            `<img src="${pothole.image_url}" alt="Pothole" style="width: 80px; height: 80px; object-fit: cover; border-radius: 5px;">` :
                            `<div style="width: 80px; height: 80px; background: #ddd; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 12px;">No Image</div>`
                        }
                        <div style="flex: 1;">
                            <p style="margin: 0 0 5px 0; font-weight: bold;">Distance: ${pothole.distance}m away</p>
                            <p style="margin: 0 0 5px 0;">Severity: ${pothole.severity}/5</p>
                            <p style="margin: 0 0 5px 0;">Reports: ${pothole.submission_count}</p>
                            <p style="margin: 0; font-size: 14px; color: #666;">${pothole.approximate_address}</p>
                        </div>
                        <button type="button" onclick="selectExistingPothole(${pothole.id})" 
                                style="background: #2c3e50; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-family: 'Shrikhand', serif;">
                            Yes, This One!
                        </button>
                    </div>
                `;
                
                potholesList.appendChild(potholeDiv);
            });
            
            modal.style.display = 'block';
        }

        function selectExistingPothole(potholeId) {
            const formData = new FormData();
            formData.append('pothole_id', potholeId);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            fetch('/api/increment-pothole-count/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = '/thank_you/';
                } else {
                    alert('Error updating pothole count. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error incrementing pothole count:', error);
                alert('Error updating pothole count. Please try again.');
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const submitBtn = document.getElementById('submit-btn');
            const submitNewBtn = document.getElementById('submit-new-pothole');
            const cancelBtn = document.getElementById('cancel-submission');
            const modal = document.getElementById('nearby-modal');

            // Intercept form submission to check for nearby potholes
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const latitude = document.getElementById('id_latitude').value;
                const longitude = document.getElementById('id_longitude').value;
                
                if (!latitude || !longitude) {
                    alert('Please select a location on the map first.');
                    return;
                }
                
                // Check for nearby potholes before submitting
                checkNearbyPotholes(latitude, longitude);
            });

            // Submit new pothole (bypass proximity check)
            submitNewBtn.addEventListener('click', function() {
                modal.style.display = 'none';
                form.removeEventListener('submit', arguments.callee);
                form.submit();
            });

            // Cancel submission
            cancelBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
{% endblock %}



