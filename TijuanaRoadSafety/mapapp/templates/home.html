{% extends 'base.html' %}

{% block title %}Welcome to Tijuana Road Safety{% endblock %}

{% block content %}
  <!-- Main Hero Section - Full Bleed -->
  <section class="main-hero" style="
    background: #586F7C;
    color: white;
    text-align: center;
    padding: 80px 20px;
    margin: -80px 0 40px 0;
    width: 100vw;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    box-sizing: border-box;
  ">
    <div style="
      max-width: 800px;
      margin: 0 auto;
    ">
      <h1 style="
        font-family: 'Figtree', sans-serif;
        font-size: 4rem;
        margin: 0 0 20px 0;
        text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        letter-spacing: 2px;
      ">¡Bienvenidos!</h1>
      <p style="
        font-family: 'Figtree', sans-serif;
        font-size: 1.3rem;
        margin: 0;
        opacity: 0.9;
        font-weight: 300;
        line-height: 1.6;
      ">Este es un proyecto cuyo objetivo es promover la transparencia de nuestro gobierno local para garantizar la seguridad de sus ciudadanos al utilizar las vías publicas. Haga su reporte por esta pagina, o por WhatsApp a este numero: (+52) 888-8888.</p>
    </div>
  </section>

  <!-- Sketch Images -->
  {% load static %}
  <!-- Hero Images -->
  <img src="{% static 'DonGermanDrawing.png' %}" class="hero-images DonGerman"> 
  <img src="{% static 'BrandonMorenoDrawing.png' %}" class="hero-images Moreno"> 
  <!-- Sketch Images -->
  <img src="{% static 'CaesarsDrawing.png' %}" class="sketch-images Caesars">
  <img src="{% static 'TijuanaDrawing.png' %}" class="sketch-images Patria">
  <img src="{% static 'CuauhtémocDrawing.png' %}" class="sketch-images Cuauhtémoc">
  <img src="{% static 'ShrekTijuanaDrawing.png' %}" class="sketch-images Shrek">
  <img src="{% static 'XoloTextoDrawing.png' %}" class="sketch-images Xolo">
  <img src="{% static 'TaqueroFDrawing.png' %}" class="sketch-images Taquero">
  <img src="{% static 'ChurrosManDrawing.png' %}" class="sketch-images Churros">
  <img src="{% static 'ArcDrawing.png' %}" class="sketch-images Arco">
  <img src="{% static 'MimoMoy.png' %}" class="sketch-images Moy">
  <img src="{% static 'MaistroDrawing.png' %}" class="sketch-images Maistro">
  <img src="{% static 'TaxistaDrawing.png' %}" class="sketch-images Taxi">
  <img src="{% static 'ZonkeyDrawing.png' %}" class="sketch-images Zonkey">
  <img src="{% static 'MunguiaVsBacheDrawing.png' %}" class="sketch-images Munguia">
  <img src="{% static 'BorderWallDrawing.png' %}" class="sketch-images Wall">
  <img src="{% static 'TorresDrawing.png' %}" class="sketch-images Torres">


    <div class="map-leaderboard-container" style="max-width: 1100px; margin: calc(20px + 12vh) auto 120px auto; display: flex; gap: 20px; align-items: stretch;">
        <!-- Map Section -->
        <div class="map-section" style="flex: 1; min-width: 0;">
            <div class="map-container" style="background: rgba(245, 243, 243, 0.95); border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: 576px; display: flex; flex-direction: column;">
                <div class="map-controls" style="margin-bottom: 10px; text-align: left;">
                    <button id="expandMapBtn" onclick="toggleMapSize()" style="
                        background: #bdbdab;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-family: 'Figtree', sans-serif;
                        font-size: 12px;
                    ">Expand Map</button>
                </div>
                <div id="map" style="flex: 1; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"></div>
            </div>
        </div>
        
        <!-- Leaderboard Section -->
        <div class="leaderboard-section" style="flex: 1; min-width: 0; margin-top: 2vh;">
            <div class="table-container" style="background: rgba(245, 243, 243, 0.95); border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: 576px; overflow-y: auto;">
                <table class="table table-striped" style="width: 100%; margin: 0; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #586F7C; color: white;">
                            <th style="padding: 6px; font-size: 11px; text-align: center;">Puesto</th>
                            <th style="padding: 6px; font-size: 11px;">Imagen</th>
                            <th style="padding: 6px; font-size: 11px;">Ubicación</th>
                            <th style="padding: 6px; font-size: 11px; text-align: center;">Num. Reportes</th>
                            <th style="padding: 6px; font-size: 11px; text-align: center;">Severidad</th>
                            <th style="padding: 6px; font-size: 11px;">Último Reporte</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pothole in top_potholes %}
                        <tr style="background-color: {% if forloop.counter0|divisibleby:2 %}rgba(255, 255, 255, 0.8){% else %}rgba(240, 240, 240, 0.8){% endif %}; border-bottom: 1px solid #ddd; cursor: pointer;" onclick="window.location.href='/report/{{ pothole.id }}/';" onmouseover="this.style.backgroundColor='rgba(200, 200, 200, 0.8)';" onmouseout="this.style.backgroundColor='{% if forloop.counter0|divisibleby:2 %}rgba(255, 255, 255, 0.8){% else %}rgba(240, 240, 240, 0.8){% endif %}';">
                            <td style="padding: 4px; font-size: 12px; text-align: center; font-weight: bold; color: #586F7C;">{{ forloop.counter }}</td>
                            <td style="padding: 4px;">
                                {% if pothole.image %}
                                    <img src="{{ pothole.image.url }}" alt="Pothole" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; box-shadow: 1px 1px 3px rgba(0,0,0,0.3);">
                                {% else %}
                                    <div style="width: 40px; height: 40px; background: #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 10px;">No Image</div>
                                {% endif %}
                            </td>
                            <td style="padding: 4px; font-size: 11px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: black;">{{ pothole.get_street_name }}</td>
                            <td style="padding: 4px; text-align: center;">
                                <span style="background: #586F7C; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: bold;">{{ pothole.submission_count }}</span>
                            </td>
                            <td style="padding: 4px; text-align: center;">
                                <div style="display: flex; align-items: center; justify-content: center;">
                                    <div style="width: 30px; height: 6px; background: #ddd; border-radius: 3px; margin-right: 4px; overflow: hidden;">
                                        <div style="width: {{ pothole.severity|floatformat:0 }}0%; height: 100%; background: {% if pothole.severity <= 2 %}#00FF00{% elif pothole.severity == 3 %}#FFFF00{% elif pothole.severity == 4 %}#FF7F00{% else %}#FF0000{% endif %};"></div>
                                    </div>
                                    <span style="font-size: 10px; font-weight: bold; color: black;">{{ pothole.severity }}/5</span>
                                </div>
                            </td>
                            <td style="padding: 4px; font-size: 10px; color: #666;">{{ pothole.latest_submission_date|default:pothole.timestamp|date:"d/m/Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" style="padding: 20px; text-align: center; color: #7f8c8d;">No pothole reports yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Map Expansion Overlay -->
    <div id="mapOverlay" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        padding: 20px;
        box-sizing: border-box;
    ">
        <div style="position: relative; width: 100%; height: 100%;">
            <button id="closeMapBtn" onclick="closeExpandedMap()" style="
                position: absolute;
                top: 10px;
                right: 10px;
                background: #e74c3c;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-family: 'Shrikhand', cursive;
                z-index: 1001;
                font-size: 14px;
            ">Close</button>
            <div id="expandedMap" style="width: 100%; height: 100%; border-radius: 10px; background: white;"></div>
        </div>
    </div>

    <!-- Memorial Section -->
    <div style="
        text-align: center;
        margin-top: 40vh;
        padding: 20px 0;
        opacity: 0.6;
        z-index: 100;
        position: relative;
    ">
        <p style="
            font-size: 11px;
            color: #777;
            margin: 0;
            font-style: italic;
            letter-spacing: 0.5px;
        ">en memoria de Andrea V.</p>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>

    <script>
        let map;
        let expandedMap;
        let markers = [];
        let expandedMarkers = [];
        let isMapExpanded = false;

        function initMap() {
            // Center on Tijuana
            const tijuana = { lat: 32.5149, lng: -117.0382 };
            
            const mapStyles = [
                {
                    "featureType": "all",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "weight": "2.00"
                        }
                    ]
                },
                {
                    "featureType": "all",
                    "elementType": "geometry.stroke",
                    "stylers": [
                        {
                            "color": "#9c9c9c"
                        }
                    ]
                },
                {
                    "featureType": "landscape",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "color": "#ffffff"
                        }
                    ]
                },
                {
                    "featureType": "road",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "color": "#eeeeee"
                        }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "color": "#c8d7d4"
                        }
                    ]
                }
            ];
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: tijuana,
                styles: mapStyles
            });

            // Add markers for each pothole
            var locations = [
                {% for report in reports %}
                    { lat: {{ report.latitude }}, lng: {{ report.longitude }}, severity: {{ report.severity }}, id: {{ report.id }} }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            locations.forEach(function(location) {
                var color;
                switch(location.severity) {
                    case 1: color = '#00FF00'; break;  // Green
                    case 2: color = '#7FFF00'; break;
                    case 3: color = '#FFFF00'; break;
                    case 4: color = '#FF7F00'; break;
                    case 5: color = '#FF0000'; break;  // Red
                }

                var marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: map,
                    title: "Pothole (Severity: " + location.severity + ")",
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                            '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">' +
                            '<circle cx="12" cy="12" r="10" fill="' + color + '" stroke="#333" stroke-width="2"/>' +
                            '<text x="12" y="16" text-anchor="middle" fill="white" font-size="12" font-weight="bold">!</text>' +
                            '</svg>'
                        ),
                        scaledSize: new google.maps.Size(24, 24)
                    }
                });

                marker.addListener('click', function() {
                    window.location.href = '/report/' + location.id + '/';
                });

                markers.push(marker);
            });
        }

        function toggleMapSize() {
            const overlay = document.getElementById('mapOverlay');
            
            if (!isMapExpanded) {
                // Show expanded map
                overlay.style.display = 'block';
                
                // Initialize expanded map after a short delay
                setTimeout(function() {
                    const tijuana = { lat: 32.5149, lng: -117.0382 };
                    expandedMap = new google.maps.Map(document.getElementById("expandedMap"), {
                        zoom: 13,
                        center: tijuana,
                        styles: [
                            {
                                "featureType": "landscape",
                                "elementType": "geometry.fill",
                                "stylers": [{"color": "#ffffff"}]
                            },
                            {
                                "featureType": "road",
                                "elementType": "geometry.fill",
                                "stylers": [{"color": "#eeeeee"}]
                            },
                            {
                                "featureType": "water",
                                "elementType": "geometry.fill",
                                "stylers": [{"color": "#c8d7d4"}]
                            }
                        ]
                    });
                    
                    // Add markers to expanded map
                    var locations = [
                        {% for report in reports %}
                            { lat: {{ report.latitude }}, lng: {{ report.longitude }}, severity: {{ report.severity }}, id: {{ report.id }} }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ];

                    locations.forEach(function(location) {
                        var color;
                        switch(location.severity) {
                            case 1: color = '#00FF00'; break;
                            case 2: color = '#7FFF00'; break;
                            case 3: color = '#FFFF00'; break;
                            case 4: color = '#FF7F00'; break;
                            case 5: color = '#FF0000'; break;
                        }

                        var expandedMarker = new google.maps.Marker({
                            position: { lat: location.lat, lng: location.lng },
                            map: expandedMap,
                            title: "Pothole (Severity: " + location.severity + ")",
                            icon: {
                                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">' +
                                    '<circle cx="12" cy="12" r="10" fill="' + color + '" stroke="#333" stroke-width="2"/>' +
                                    '<text x="12" y="16" text-anchor="middle" fill="white" font-size="12" font-weight="bold">!</text>' +
                                    '</svg>'
                                ),
                                scaledSize: new google.maps.Size(24, 24)
                            }
                        });
                        
                        expandedMarker.addListener('click', function() {
                            window.location.href = '/report/' + location.id + '/';
                        });
                        
                        expandedMarkers.push(expandedMarker);
                    });
                }, 200);
                
                isMapExpanded = true;
            }
        }

        function closeExpandedMap() {
            const overlay = document.getElementById('mapOverlay');
            overlay.style.display = 'none';
            isMapExpanded = false;
            
            // Clean up expanded map
            if (expandedMap) {
                expandedMap = null;
            }
            expandedMarkers = [];
        }
    </script>
{% endblock %}
